# Заметки по доработке модуля "Шаблоны"

Этот документ содержит описание задач и логики для доработки модуля `Templates`.

## Текущие тезисы

1.  **Рефакторинг сервисов.** Проводится объединение логики из `TemplatesService`, `AbstractProductService` и других в единый `TemplatesModuleService` для централизованного управления иерархией сущностей.
2.  **Проблема.** Основная мотивация - устранение "непонятных ошибок" при копировании/дублировании продуктов и их дочерних элементов.

*(...здесь будут добавляться следующие пункты...)*

## Описание работы модуля "Шаблоны"

### 0. Общая структура и поведение

*   **Иерархия:** Модуль представляет собой иерархическую структуру: `Templates` -> `Set<AbstractProductType>` -> `List<ProductOperation>`. `ProductOperation` в свою очередь ссылается на справочную сущность `Operation`.
*   **Отображение:** В пользовательском интерфейсе эта структура выводится в виде `TreeGrid<Object>`.
*   **Копирование:** При дублировании любого элемента иерархии (шаблона, продукта или операции) создается его **глубокая копия**, включая все дочерние элементы. Это гарантирует, что изменения в копии не затронут оригинал.

### 1. Сущность `Templates` (Шаблон)

*   **Назначение:** Корневой элемент иерархии. Является контейнером для одного или нескольких "Продуктов", которые вместе составляют конечное изделие (например, визитка, брошюра).
*   **Основные атрибуты:**
    *   `name`: Название шаблона (например, "Визитка 90х50").
    *   `description`: Описание.
    *   `photo`: Фотография конечного продукта (будет реализовано позже).
*   **Глобальные переменные:**
    *   `Templates` содержит набор динамических **глобальных переменных** (`List<Variable>`).
    *   Эти переменные являются общими для всех "Продуктов" внутри шаблона и могут использоваться в формулах для расчетов.
    *   При создании нового шаблона, базовый набор переменных подгружается из `TemplateVariableService`. Пример переменных:
        *   `quantity` (тираж) с его ограничениями на начальное, максимальное и шаг
        *   `margin` (маржа)
        *   `tax` (налог)
        *   `worker_rate` (стоимость нормо-часа)
        *   и другие.
        *   Есть формула округления стоимости (groovy)

### 2. Сущность `AbstractProductType` (Продукт/Компонент)

*   **Назначение и роль:** Промежуточный уровень иерархии. `AbstractProductType` — это абстрактный контейнер, который объединяет в себе технологические операции (`List<ProductOperation>`) и набор динамических переменных (`List<Variable>`), необходимых для расчета одной составной части конечного изделия.
    *   *Пример 1:* Для визитки может быть один "Продукт" - "Однолистовая печать".
    *   *Пример 2:* Для книги может быть два "Продукта" - "Обложка" и "Внутренний блок".
*   **Реализации и наследование:** Вся бизнес-логика сосредоточена в классах-наследниках. Процесс копирования также должен быть реализован для каждой конкретной реализации.
    *   `OneSheetDigitalPrintingProductType`: Компонент для однолистовой цифровой печати (визитки, листовки).
    *   `MultiplySheetsDigitalPrintingProductType` (в планах): Компонент для многостраничной продукции (брошюры).
    *   `WideFormatProductType` (в планах): Компонент для широкоформатной печати.
*   **Связь с материалами (ключевой аспект):** Каждый класс-наследник `AbstractProductType` жестко определяет, с каким **типом** материалов он работает. Это позволяет иметь специфичные для материала атрибуты.
    *   **Пример 1:** `OneSheetDigitalPrintingProductType` работает с листовыми материалами, поэтому его поля `defaultMaterial` и `selectedMaterials` имеют тип `PrintSheetsMaterial` (наследник `AbstractMaterials`), у которого есть поля `sizeX`, `sizeY`, `thickness`.
    *   **Пример 2 (в будущем):** `WideFormatProductType` будет работать с рулонными материалами, и его поля будут иметь тип `WideFormatMaterial` (другой наследник `AbstractMaterials`) со своими атрибутами, например, `width` (ширина рулона) и `density` (плотность).
*   **Переменные компонента:**
    *   Каждый тип "Продукта" имеет свой собственный набор переменных, которые определяют его технологические параметры.
    *   Переменные подгружаются из `ProductTypeVariableService` при создании нового компонента.
    *   *Пример для `OneSheetDigitalPrintingProductType`:*
        *   `productWidth`, `productLength` (размеры изделия)
        *   `bleed` (вылеты под обрез)
        *   `multiplication` (флаг, разрешающий размещать несколько изделий на одном печатном листе)
*   **Связи:**
    *   Принадлежит одному `Templates`.
    *   Содержит упорядоченный список технологических операций (`List<ProductOperation>`).

### 3. Сущность `ProductOperation` (Операция в продукте)

*   **Назначение:** Самый нижний уровень иерархии в шаблоне. Представляет собой **конкретную технологическую операцию**, которая будет выполняться в рамках одного "Продукта" (`AbstractProductType`). Например: "Печать", "Резка", "Ламинация".
*   **Создание:** `ProductOperation` создается на основе справочной сущности `Operation`. При создании она "копирует" из `Operation` все необходимые данные, что позволяет в дальнейшем изменять их, не затрагивая исходный шаблон операции.
*   **Основные атрибуты и логика:**
    *   `operation`: Ссылка на шаблон `Operation`, из которого она была создана.
    *   `name`: Собственное имя операции в рамках продукта (например, "Печать обложки"), которое может отличаться от имени в шаблоне `Operation`.
    *   `sequence`: Порядковый номер, определяющий последовательность выполнения операций внутри "Продукта".
    *   `switchOff`: Флаг, разрешающий пользователю отключать эту операцию при оформлении заказа.
*   **Переменные операции (`customVariables`):**
    *   При создании `ProductOperation` в нее **глубоко копируется** список переменных (`List<Variable>`) из `Operation`.
    *   Это позволяет для каждой конкретной операции в продукте переопределить значения по умолчанию. Например, для операции "Резка" в продукте "Визитка" можно установить процент брака 2%, а в продукте "Листовка" - 1%, не меняя при этом базовый шаблон "Резка".
    *   **Отображение в UI:** В редакторе `ProductOperationEditor` переменные-формулы (`machineTimeFormula`, `actionFormula` и т.д.) скрываются от пользователя, чтобы он мог настраивать только параметры, а не логику расчета.
*   **Материалы операции:**
    *   `selectedMaterial`: Конкретный материал, выбранный для этой операции из списка доступных в `Operation`.
    *   *Пример:* Шаблон `Operation` "Печать" может предлагать на выбор материалы "Цветная печать" и "Ч/Б печать". В `ProductOperation` для обложки книги будет выбрана "Цветная печать", а для внутреннего блока - "Ч/Б печать".
*   **Связи:**
    *   Принадлежит одному `AbstractProductType`.
    *   Ссылается на один `Operation`.

### 4. Сущность `Operation` (Шаблон/справочник операции)

*   **Назначение:** Это сущность из **справочника**, которая выступает в роли **шаблона или "фабрики"** для создания `ProductOperation`. Она описывает типовую технологическую операцию, ее параметры по умолчанию и доступные для нее материалы.
*   **Основные атрибуты:**
    *   `name`: Название операции в справочнике (например, "Цифровая печать", "Резка гильотинная").
    *   `typeOfOperation`: Категория операции (например, "Печатные", "Постпечатные"), используется для группировки в UI.
    *   `switchOff`: Значение по умолчанию для флага, разрешающего отключать операцию в заказе.
*   **Переменные (`List<Variable>`):**
    *   Содержит **шаблонный набор переменных** для этой операции.
    *   Именно здесь хранятся **ключевые формулы расчета** на Groovy, которые будут скопированы в `ProductOperation`:
        *   `machineTimeFormula`: Формула расчета времени работы оборудования.
        *   `actionFormula`: Формула расчета времени ручной работы сотрудника.
        *   `materialFormula`: Формула расчета количества расходного материала операции.
        *   `operationWasteFormula`: Формула расчета технологического брака.
        *   `setupWasteFormula`: Формула расчета приладки.
*   **Роль в иерархии:** `Operation` не является частью самого шаблона `Templates`, а является независимой справочной сущностью. `ProductOperation` лишь ссылается на нее, копируя при создании все необходимые данные. Это гарантирует, что изменения в справочнике операций не сломают уже настроенные шаблоны продуктов.
*   **Связь с оборудованием и материалами операции (ключевая логика):**
    *   `abstractMachine`: `Operation` связана с конкретной единицей оборудования (`AbstractMachine`). См. раздел 5.
    *   Выбор оборудования **определяет**, какие расходные материалы будут доступны для этой операции.
    *   `listOfMaterials` в `Operation` — это **подмножество** материалов из `AbstractMachine.abstractMaterials`. Технолог, настраивая `Operation`, выбирает из всех материалов машины только те, которые подходят для данной конкретной операции.
    *   `defaultMaterial`: Материал операции, который будет выбран по умолчанию при создании `ProductOperation`.

### 5. Сущность `AbstractMachine` (Оборудование)

*   **Назначение:** Описывает единицу оборудования (принтер, резак, ламинатор). Является источником технических и экономических параметров для `Operation`.
*   **Реализации:** `DigitalPrintingMachine`, `CutterMachine` (в планах), `LaminatorMachine` (в планах).
*   **Переменные (`List<Variable>`):**
    *   Содержит **технические переменные**, специфичные для данного оборудования.
    *   *Примеры для `DigitalPrintingMachine`:* `gap_top`, `gap_bottom` (непечатные поля), `max_width`, `max_length` (макс. размер листа), `cost_per_hour` (стоимость амортизации).
    *   *Источник:* `MachineVariableService`.
*   **Связь с материалами (ключевой аспект):**
    *   Каждая единица оборудования (`AbstractMachine`) связана с набором **своих** расходных материалов (`Set<AbstractMaterials>`).
    *   Это **не** основной материал продукта (как бумага), а именно **расходники самой машины**.
    *   *Пример 1:* `DigitalPrintingMachine` связан с материалами типа `PrintingMaterials` (клики/краска: "Цветная 4+0", "Ч/Б 1+0").
    *   *Пример 2 (в будущем):* `LaminatorMachine` будет связан с материалами типа `LaminationFilm` ("Матовая пленка", "Глянцевая пленка").
    *   *Пример 3 (в будущем):* `StaplerMachine` будет связан с `Staples` ("Скоба 6мм", "Скоба 8мм").
*   **Роль в иерархии:** `AbstractMachine` — это справочная сущность, на которую ссылается `Operation`.
*   **Связь со стоимостью (амортизация):**
    *   Стоимость часа работы оборудования не хранится напрямую в `AbstractMachine`.
    *   Вместо этого, `AbstractMachine` связан отношением "один ко многим" с сущностью `PriceOfMachine`. См. раздел 7.

### 6. Сущность `AbstractMaterials` (Материалы)

*   **Назначение:** Абстрактный базовый класс для **всех** типов материалов в системе. Он объединяет как основные материалы продукта (например, бумага), так и расходные материалы операций (клики, пленка, скобы).
*   **Реализации (Полиморфизм):**
    *   `PrintSheetsMaterial`: Листовые материалы (бумага, картон), используемые в `AbstractProductType`. Имеют атрибуты `sizeX`, `sizeY`, `thickness`.
    *   `PrintingMaterials`: Расходники для печатных машин (клики, тонер), используемые в `Operation`.
    *   `LaminationFilm` (в планах): Пленка для ламинации.
    *   `Staples` (в планах): Скобы для скрепления.
*   **Роль в иерархии:** `AbstractMaterials` и его наследники являются справочными сущностями. Они могут быть связаны как с `AbstractProductType` (основной материал), так и с `AbstractMachine` (расходные материалы, доступные для `Operation`).
*   **Связь со стоимостью:**
    *   Цена не хранится напрямую в `AbstractMaterials`.
    *   Вместо этого, `AbstractMaterials` связан отношением "один ко многим" с сущностью `PriceOfMaterial`. См. раздел 7.

### 7. Сущности ценообразования (PriceOf...)

*   **Назначение:** Для гибкого управления стоимостью в системе используются отдельные сущности для хранения цен, что позволяет вести историю их изменения.

#### 7.1. Сущность `PriceOfMaterial` (Цена на материал)

*   **Структура:** Это отдельная справочная сущность, которая содержит:
    *   `material`: Ссылка на `AbstractMaterials` (какой материал).
    *   `price`: Цена за единицу.
    *   `effectiveDate`: Дата, с которой действует эта цена.
*   **Централизованное управление:** Все цены на все материалы хранятся в одной таблице. Это позволяет создать единый интерфейс (`PriceOfMaterialView`) для просмотра и редактирования всех цен в системе, с возможностью фильтрации по конкретному материалу.
*   **Роль:** При расчете заказа система находит последнюю актуальную цену для нужного материала по `effectiveDate`.

#### 7.2. Сущность `PriceOfMachine` (Цена на оборудование / Амортизация)

*   **Структура:** Аналогично ценам на материалы, эта сущность содержит:
    *   `machine`: Ссылка на `AbstractMachine` (какое оборудование).
    *   `price`: Стоимость нормо-часа.
    *   `effectiveDate`: Дата, с которой действует эта цена.
*   **Централизованное управление:** Управление стоимостью часа работы всего оборудования происходит в едином интерфейсе (`PriceOfMachineView`).

### 8. Процесс глубокого копирования (Duplication)

Этот раздел описывает правильную логику дублирования иерархии `Templates` -> `AbstractProductType` -> `ProductOperation`, которая реализована в `TemplatesModuleService`.

#### 8.1. Копирование `Templates`

*   **Действие:** `TemplatesModuleService.duplicateTemplate(originalTemplate)`
*   **Логика:**
    1.  Создается новый объект `Templates` (в состоянии `transient`).
    2.  Копируются примитивные поля (`name` с постфиксом, `description`).
    3.  Выполняется глубокое копирование списка `variables` с помощью конструктора `new Variable(originalVariable)`.
    4.  Для каждого `AbstractProductType` из `originalTemplate.getProductTypes()` вызывается `createTransientProductDuplicate()`.
    5.  Набор полученных *транзиентных* копий продуктов устанавливается в `newTemplate.setProductTypes()`.
    6.  Вызывается `templatesRepository.save(newTemplate)`. Благодаря `CascadeType.ALL` (или аналогичному механизму), сохраняется вся иерархия одним вызовом.

#### 8.2. Копирование `AbstractProductType`

*   **Действие:** `TemplatesModuleService.createTransientProductDuplicate(originalProduct)`
*   **Логика (на примере `OneSheetDigitalPrintingProductType`):**
    1.  Создается новый объект `OneSheetDigitalPrintingProductType` (`transient`).
    2.  Копируются его поля (`name`).
    3.  Выполняется глубокое копирование `variables`.
    4.  **Копируются ссылки на материалы:**
        *   Ссылки на `defaultMaterial` и `selectedMaterials` (например, бумага) просто копируются. Это справочные данные, их дублировать не нужно.
    5.  **Копируются дочерние `ProductOperation`:**
        *   Для каждой `originalOperation` из `originalProduct.getProductOperations()` создается ее копия: `new ProductOperation(originalOperation)`.
        *   У новой операции `newOp` устанавливается ссылка на новый продукт: `newOp.setProduct(newProduct)`. Это критически важно для двунаправленной связи.
    6.  Возвращается `transient` копия продукта.

#### 8.3. Копирование `ProductOperation`

*   **Действие:** `new ProductOperation(originalOperation)` (конструктор копирования).
*   **Логика:**
    1.  Создается новый объект `ProductOperation`.
    2.  Копируются примитивные поля (`name`, `sequence`, `switchOff`).
    3.  **Копируются ссылки на справочники:** `operation` и `selectedMaterial` (например, тонер).
    4.  Выполняется глубокое копирование списка `customVariables`.
    5.  **Важно:** Ссылка на родительский `product` **не копируется**. Она должна быть установлена извне, в вызывающем коде (что и делает `createTransientProductDuplicate`).